var d=(t,e,r)=>new Promise((a,i)=>{var u=n=>{try{c(r.next(n))}catch(s){i(s)}},p=n=>{try{c(r.throw(n))}catch(s){i(s)}},c=n=>n.done?a(n.value):Promise.resolve(n.value).then(u,p);c((r=r.apply(t,e)).next())});import*as b from"expo-web-browser";import{Extension as C}from"@magic-sdk/react-native";import I from"crypto-js/sha256";import _ from"crypto-js/enc-base64";var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",f=typeof window!="undefined"&&!!window.crypto,v=f&&!!window.crypto.subtle;function U(t){return Array.from(t).map(e=>m[e%m.length]).join("")}function y(t){let e=r=>r.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");if(t instanceof ArrayBuffer){let r=new Uint8Array(t),a=Array.from(r).map(u=>String.fromCharCode(u)).join(""),i=btoa(a);return e(i)}return e(_.stringify(t))}function O(t){return d(this,null,function*(){if(v){let e=new TextEncoder().encode(t);return crypto.subtle.digest("SHA-256",e).then(y)}return y(I(t))})}function h(t){let e=new Uint8Array(t);if(f)window.crypto.getRandomValues(e);else for(let r=0;r<t;r+=1)e[r]=Math.floor(Math.random()*Math.floor(255));return U(e)}function R(){return d(this,null,function*(){let t=h(128),e=h(128),r=yield O(e);return{verifier:e,challenge:r,state:t}})}var A=(e=>(e.ParseRedirectResult="magic_oauth_parse_redirect_result",e))(A||{}),w=(o=>(o.InvalidRequest="invalid_request",o.InvalidClient="invalid_client",o.InvalidScope="invalid_scope",o.InvalidGrant="invalid_grant",o.UnauthorizedClient="unauthorized_client",o.UnsupportedResponseType="unsupported_response_type",o.UnsupportedGrantType="unsupported_grant_type",o.UnsupportedTokenType="unsupported_token_type",o.AccessDenied="access_denied",o.ServerError="server_error",o.TemporarilyUnavailable="temporarily_unavailable",o))(w||{});var x=class extends C.Internal{constructor(){super(...arguments);this.name="oauth";this.config={};this.compat={"magic-sdk":!1,"@magic-sdk/react-native":">=2.7.0"}}loginWithPopup(e){return this.utils.createPromiEvent((r,a)=>d(this,null,function*(){try{let{provider:i,query:u,redirectURI:p}=yield E.call(this,e),c=`https://auth.magic.link/v1/oauth2/${i}/start?${u}`,n=yield b.openAuthSessionAsync(c,p);if(n.type==="success"){let s=new URL(n.url).search;r(D.call(this,s.toString()))}else a(this.createError(n.type,"User has cancelled the authentication",{}))}catch(i){a(this.createError(i.message,"An error has occurred",{err:i}))}}))}},g="oauth_redirect_metadata";function E(t){return d(this,null,function*(){yield this.utils.storage.removeItem(g);let{provider:e,redirectURI:r,scope:a,loginHint:i}=t,{verifier:u,challenge:p,state:c}=yield R(),n=JSON.stringify({verifier:u,state:c});return yield this.utils.storage.setItem(g,n),{query:[`magic_api_key=${encodeURIComponent(this.sdk.apiKey)}`,`magic_challenge=${encodeURIComponent(p)}`,`state=${encodeURIComponent(c)}`,`platform=${encodeURIComponent("rn")}`,a&&`scope=${encodeURIComponent(a.join(" "))}`,r&&`redirect_uri=${encodeURIComponent(r)}`,i&&`login_hint=${encodeURIComponent(i)}`].reduce((l,o)=>o?`${l}&${o}`:l),provider:e,redirectURI:r}})}function D(t){return this.utils.createPromiEvent((e,r)=>d(this,null,function*(){var l;let a=yield this.utils.storage.getItem(g),{verifier:i,state:u}=JSON.parse(a);this.utils.storage.removeItem(g);let p=this.utils.createJsonRpcRequestPayload("magic_oauth_parse_redirect_result",[t,i,u]),c=yield this.request(p),n=c,s=c;s.error&&r(this.createError(s.error,(l=s.error_description)!=null?l:"An error occurred.",{errorURI:s.error_uri,provider:s.provider})),e(n)}))}export{w as OAuthErrorCode,x as OAuthExtension,A as OAuthPayloadMethods,E as createURI,D as getResult};
//# sourceMappingURL=index.js.map
